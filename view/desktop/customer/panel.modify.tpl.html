<?php use \Tuanduimao\Loader\App as App; ?>
<div class="content <?php 
                if($type=='read'){

                    echo "hide";
                   
                }?> 

                <?php 
                if($type=='update'){

                    echo "show";
                   
                }?>  xiugaitype">
	<div class="change">
	   <form class="js-validation-CoreDeptUserupdate form-horizontal push-10-t" action="<?=App::NR('CustomerData','save')?>" method="post">
            <div class="form-group">
                <!-- 公司名称 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="company" name="company" placeholder="请填写公司名称" value="<?=!empty($data['company'])?$data['company']:"" ?>">
                        <label for="material-text">公司名称<span class="mustbe"> *</span></label>
                    </div>
                </div>

                <input class="hide" type="text" id="_id" name="_id"  value="<?=!empty($data['_id'])?$data['_id']:"" ?>">
                <!-- 联系人编号 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="num" name="num" placeholder="请填写编号" value="<?=!empty($data['num'])?$data['num']:"" ?>">
                        <label for="material-text">编号</label>
                    </div>
                </div>
                <!-- 联系人标号结束 -->
            </div>

            <div class="form-group">
                <!-- 联系人 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="name" name="name" placeholder="请填写联系人" value="<?=!empty($data['name'])?$data['name']:"" ?>">
                        <label for="material-text">联系人<span class="mustbe"> *</span></label>
                    </div>
                </div>
                <!-- 联系人结束 -->
                <!-- 联系人职务 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="title" name="title" placeholder="请填写联系人职务" value="<?=!empty($data['title'])?$data['title']:"" ?>">
                        <label for="material-text">联系人职务<span class="mustbe"> *</span></label>
                    </div>
                </div>
                <!-- 联系人职务end -->
            </div>

            <div class="form-group">
                <!-- 联系人手机号 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="mobile" name="mobile" placeholder="请填写联系人手机号" value="<?=!empty($data['mobile'])?$data['mobile']:"" ?>">
                        <label for="material-text">联系人手机号<span class="mustbe"> *</span></label>
                    </div>
                </div>
                <!-- 联系人手机号end -->
                <!-- 联系人邮箱 -->
                <div class="col-sm-6">
                    <div class="form-material">
                        <input class="form-control" type="text" id="email" name="email" placeholder="请填写联系人邮箱" value="<?=!empty($data['email'])?$data['email']:"" ?>">
                        <label for="material-text">联系人邮箱<span class="mustbe"> *</span></label>
                    </div>
                </div>
                <!-- 联系人邮箱end -->
            </div>

            <div class="form-group">
                <!-- 联系人地址 -->
                <div class="col-sm-12">
                    <div class="form-material">
                        <input class="form-control" type="text" id="address" name="address" placeholder="请填写联系人地址" value="<?=!empty($data['address'])?$data['address']:"" ?>">
                        <label for="material-text">联系人地址<span class="mustbe"> *</span></label>
                    </div>
                </div>
                <!-- 联系人地址 -->
            </div>

            <!-- 客户备注 -->
            <div class="form-group">
                <div class="col-xs-12">
                    <div class="form-material">
                        <textarea class="form-control" id="remark" name="remark" rows="8" placeholder="请填写客户备注" value="<?=!empty($data['remark'])?$data['remark']:"" ?>"><?=!empty($data['remark'])?$data['remark']:"" ?></textarea>
                        <label for="material-textarea-large">客户备注<span class="mustbe"> *</span></label>
                    </div>
                </div>
            </div>
            <!-- 客户备注结束 -->
            <!-- 操作按钮区域 -->
            <div class="form-group">
                <div class="col-xs-12">
                    <!-- 保存 -->
                    <div class="col-xs-3">
                         <div class="form-material">
                            <button class="btn btn-minw btn-primary pull-left" type="submit">保存</button>
                        </div> 
                    </div>
                    <!-- 保存结束 -->
                    <div class="col-xs-3">
                     
                    </div>
                    <!-- 阅读模式 -->
                    <div class="col-xs-4 push-100-r">
                         <div class="form-material">
                            <button class="btn btn-minw btn-primary pull-right change-type content-yuedu pull-right" type="button">阅读模式</button>
                        </div> 
                    </div>
                    <!-- 阅读模式end -->
                </div>
            </div>
            <!-- 操作按钮区域结束 -->

        </form>
   </div>
</div>

<script>
    $(function(){
        // 修改模式切换阅读模式
        $('.content-yuedu').click(function(event) {
            $('.yuedutype').addClass('show');
            $('.xiugaitype').addClass('hide');
            $('.yuedutype').removeClass('hide');
            $('.xiugaitype').removeClass('show');
            
        });
    })


    // 验证表单
    // 验证采用validate插件
    // 具体验证规则可以参考validate手册

    $(function(){

        $('.js-validation-CoreDeptUserupdate').validate({
                errorClass: 'help-block text-right animated fadeInDown',
                errorElement: 'div',
                errorPlacement: function(error, e) {                
                    jQuery(e).parents('.form-group .form-material').append(error);
                },
                highlight: function(e) {
                    jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error').addClass('has-error');
                    jQuery(e).closest('.help-block').remove();
                },
                unhighlight:function(e){
                    jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                    jQuery(e).closest('.help-block').remove();
                },
                success: function(e) {
                    jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                    jQuery(e).closest('.help-block').remove();
                },

                submitHandler: function(form) {

                    var self = this;
                    // // 把from提交的内容进行截断,调用UserDataSubmit方法;
                    DataSubmit(self, form,function callback(){

                            App.notify( '操作成功' );
                    });
                },
                rules: {
                    'company': {
                            required: true,
                            minlength: 2,
                            maxlength: 200,
                    },
                    'num': {
                            minlength: 2,
                            maxlength: 20,
                    },
                    'name': {
                            required: true,
                            minlength: 2,
                            maxlength: 20,
                    },
                    'title' : {
                            required: true,
                            minlength: 2,
                            maxlength: 20,
                    },
                    'mobile':{
                        required: true,
                        minlength:11,
                        number:true
                    },
                    'email': {
                            required: true,
                            minlength: 2,
                            maxlength: 80,
                            email:true
                    },
                    'address': {
                            required: true,
                            minlength: 2,
                            maxlength: 200,
                    },
                    'remark': {
                            required: true,
                            minlength: 2,
                            maxlength: 200,
                    },

                },
                
                messages: {
                    'company': {
                        required: '请填写公司名称',
                        minlength: '公司名称不能少于2个字',
                        maxlength: '公司名称不能超过200个字',
                    },
                    'num' : {
                        minlength: '编号不能少于2个字',
                        maxlength: '编号不能超过20个字',

                    },
                    'name': {
                        required: '请填写联系人名称',
                        minlength: '联系人名称不能少于2个字',
                        maxlength: '联系人名称不能超过20个字',
                    },
                    'title': {
                        required: '请填写联系人职务',
                        minlength: '联系人职务不能少于2个字',
                        maxlength: '联系人职务不能超过80个字',
                    }, 
                    'mobile':{
                        required: '请填写手机号',
                        minlength:'长度为11位',
                        number:'必须为数字',
                    },
                    'email': {
                        required: '请填写联系人职务',
                        minlength: '联系人职务不能少于2个字',
                        maxlength: '联系人职务不能超过80个字',
                        email: "请输入有效的电子邮件地址",
                    },
                    'address': {
                        required: '请填写联系地址',
                        minlength: '联系地址不能少于2个字',
                        maxlength: '联系地址不能超过200个字',
                    },
                    'remark': {
                        required: '请填写客户备注',
                        minlength: '客户备注不能少于2个字',
                        maxlength: '客户备注不能超过200个字',
                    },

                },
        });




    })

    /**
     * 提交表单 
     * @param {[type]} validation [description]
     * @param {[type]} form       [description]
     */
    function DataSubmit( validation, form ,callback) {


        var api = $(form).attr('action');
        var next = $(form).attr('data-next');
        var submits = $('button[type="submit"]', form);
        $(submits).attr('disabled', 'disabled');
        $(submits).addClass('disabled');

        var data = {};

        var formData =  $(form).serializeArray();
            for( var i=0; i<formData.length; i++ ) {
                var name = formData[i]['name'];
                var value = formData[i]['value'];

                if (value !== "") {
                    data[name] = value;
                }
            }

       

        // 特殊数值处理
        if ( typeof data['department'] != 'undefined' ) {        
            data['department'] =  $('select[name="department"]').val();
        }

        if ( typeof data['avatar_path'] != 'undefined' ) {        
            data['avatar'] =  data['avatar_path'];
            delete data['avatar_path'];
            delete data['avatar_url'];
        }

        data = jQuery.extend(data, {});
        $.post( api, data, function(data, textStatus, xhr) {

            $(submits).removeAttr('disabled');
            $(submits).removeClass('disabled');




            if (data['result']==false){

                App.notify( '操作失败'+data['content'], 'fa fa-times','danger');
                
                return;

            };
            
            // 全局通知
            callback();
            window.location.reload();
            return;

        },'json')
    }

</script>
 <style>
 .mustbe{
    color:red;
}
</style>
